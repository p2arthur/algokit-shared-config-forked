name: Publish Docs to Algorand Developer Portal
description: Publishes documentation to a dedicated docs branch for consumption by the Developer Portal

inputs:
  docs_path:
    description: "Location relative to the repo root of the docs folder"
    required: false
    default: ".devportal"
  docs_branch:
    description: "Name of the branch to publish the docs to"
    required: false
    default: "docs-dist"
  github_token:
    description: "GitHub token for publishing to docs branch"
    required: true

outputs:
  docs_target:
    description: "The version target that was published (e.g., 'latest' or 'v1.2.3')"
    value: ${{ steps.docs_target.outputs.target }}

runs:
  using: composite
  steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x

    - name: Install dependencies
      run: npm ci
      shell: bash

    - name: Setup typedoc configuration
      shell: bash
      run: node "${{ github.action_path }}/typedoc-config.js"

    - name: Build docs
      shell: bash
      run: npx typedoc --options typedoc.devportal.json

    - name: Copy guides to staging folder
      shell: bash
      run: |
        if [[ -d "docs/guides" ]]; then
          mkdir -p "${{ inputs.docs_path }}/guides"
          cp -R docs/guides/. "${{ inputs.docs_path }}/guides/"
          echo "âœ… Copied guides folder to ${{ inputs.docs_path }}/guides"
        else
          echo "â„¹ï¸  No guides folder found at docs/guides, skipping"
        fi

    - name: Generate manifest
      shell: bash
      run: node "${{ github.action_path }}/generate-manifest.mjs" "${{ inputs.docs_path }}" "${{ github.repository }}" "${{ github.sha }}"

    - name: Determine docs target
      id: docs_target
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          tag="${{ github.event.release.tag_name }}"
          if [[ -z "$tag" ]]; then
            echo "Release event missing tag_name" >&2
            exit 1
          fi
          # Strip leading 'v' if present to get clean version
          version="${tag#v}"
          target="v${version}"
        else
          target="latest"
        fi
        echo "target=$target" >> "$GITHUB_OUTPUT"
        echo "Publishing to: $target"

    - name: Checkout docs branch
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.docs_branch }}
        path: docs-branch-temp
      continue-on-error: true

    - name: Clear target directories
      shell: bash
      run: |
        target="${{ steps.docs_target.outputs.target }}"

        # Remove target version directory if it exists
        if [[ -d "docs-branch-temp/${target}" ]]; then
          rm -rf "docs-branch-temp/${target}"
          echo "ðŸ—‘ï¸  Cleared existing ${target} directory"
        fi

        # Also remove latest directory on release
        if [[ "${{ github.event_name }}" == "release" ]] && [[ -d "docs-branch-temp/latest" ]]; then
          rm -rf "docs-branch-temp/latest"
          echo "ðŸ—‘ï¸  Cleared existing latest directory"
        fi

        # Remove the .git directory to avoid conflicts
        rm -rf docs-branch-temp/.git

        # Use this as the base for publishing
        mkdir -p publish-staging
        if [[ -d "docs-branch-temp" ]]; then
          cp -R docs-branch-temp/. publish-staging/
        fi
        rm -rf docs-branch-temp

    - name: Stage new docs
      shell: bash
      run: |
        target="${{ steps.docs_target.outputs.target }}"

        # Copy new docs to target version
        mkdir -p "publish-staging/${target}"
        cp -R "${{ inputs.docs_path }}/." "publish-staging/${target}/"
        echo "âœ… Staged docs for ${target}"

        # Also copy to latest on release
        if [[ "${{ github.event_name }}" == "release" ]]; then
          mkdir -p "publish-staging/latest"
          cp -R "${{ inputs.docs_path }}/." "publish-staging/latest/"
          echo "âœ… Staged docs for latest"
        fi

    - name: Publish docs branch
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ inputs.github_token }}
        publish_dir: publish-staging
        publish_branch: ${{ inputs.docs_branch }}
        keep_files: false

    - name: Summary
      if: always()
      shell: bash
      run: |
        echo "## Documentation Publish Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Version target**: \`${{ steps.docs_target.outputs.target || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Documentation Branch**: \`${{ inputs.docs_branch }}\`" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "- **Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Build Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ Documentation published successfully. The DevPortal will sync these changes during its next nightly update." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Need immediate update?** Navigate to the DevPortal repository Actions tab and manually trigger the documentation import workflow." >> $GITHUB_STEP_SUMMARY
