name: "Run typedoc and publish to pages"

on:
  workflow_call:

jobs:
  # ------------------------------------------------------------------------
  # 1. ALGO-KIT DOCS BUILD
  # ------------------------------------------------------------------------
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Build Typedoc Documentation
        uses: algorandfoundation/algokit-shared-config/.github/actions/generate-typescript-docs@main
      - name: Upload Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages-docs
          path: docs/_html
          retention-days: 1

  # ------------------------------------------------------------------------
  # 2. ALGO-KIT GITHUB PAGES DEPLOY
  # ------------------------------------------------------------------------
  publish-docs:
    needs: build-docs
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Download Documentation Artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages-docs
          path: docs/downloaded

      - name: Deploy Documentation
        uses: algorandfoundation/algokit-shared-config/.github/actions/publish-docs@main
        with:
          artifact_path: docs/downloaded

  # ------------------------------------------------------------------------
  # 3. DEV PORTAL COORDINATION (The previously nested job, now corrected)
  # ------------------------------------------------------------------------
  manage-docs-dist-branch: # <-- New Job Name
    needs: [build-docs, publish-docs]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # ðŸ›‘ CORRECT SYNTAX: Use 'uses:' at the job level to call a reusable workflow
    uses: ./.github/workflows/devportal/publish-docs-dist.yml
    with:
      artifact_name: github-pages-docs
      docs_path_in_artifact: "."
      docs_branch: "docs-dist"
    # Outputs are handled by the reusable workflow definition

  # ------------------------------------------------------------------------
  # 4. DEV PORTAL NOTIFICATION (Job 2 - Mocks the notify script)
  # ------------------------------------------------------------------------
  mock-devportal-notify: # <-- New Job Name
    needs: [build-docs, manage-docs-dist-branch] # Now depends on the branch management job
    runs-on: ubuntu-latest
    permissions:
      contents: read # Only read is needed for checkout and running the script

    # Check the output of the reusable workflow job
    if: needs.manage-docs-dist-branch.outputs.pushed_to_dist == 'true'

    steps:
      - name: Checkout Source Code (for devportal scripts)
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Mock DevPortal Notification
        id: notify-devportal
        # Use the mocked script
        run: node devportal/scripts/notify-devportal-test.mjs
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "## Documentation Publish Summary (TEST ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "- **Docs Dist Branch Status**: ${{ needs.manage-docs-dist-branch.outputs.pushed_to_dist == 'true' && 'âœ… Updated' || 'âš ï¸ No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DevPortal Notification**: âœ… Skipped (Running in Test Mode)" >> $GITHUB_STEP_SUMMARY
