# .github/workflows/algokit-node-build-zip.yml - REVISED
name: Generic Node.js Build and Zip

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: 20.x
      working-directory:
        required: false
        type: string
        default: "."
      build-path:
        required: false
        type: string
        default: dist
      artifact-name:
        required: false
        type: string
        default: node-artifact
      static-site:
        required: false
        type: boolean
        default: false
        description: Set to true for static sites to enable build-time environment variable substitution.
      static-site-env-prefix:
        required: false
        type: string
        default: VITE
        description: Environment variable prefix (e.g., VITE for Vite, REACT_APP for CRA).
      pre-run-script:
        required: false
        type: string
      sample-env-path:
        required: false
        type: string
        default: .env.sample
        description: Path to the .env file containing environment variable keys.
    secrets:
      npm-auth-token:
        description: Custom NPM auth token for private package access (optional).
        required: false
      github-token:
        # REQUIRED CHANGE: Removed default: ${{ github.token }}
        description: GITHUB_TOKEN for package access. Caller should pass ${{ secrets.GITHUB_TOKEN }} or secrets.inherit
        required: false

jobs:
  build-zip:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: ‚öôÔ∏è Checkout Repository
        uses: actions/checkout@v4

      # --- Setup Node.js ---

      - name: üü¢ Set up Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      # --- Authentication Setup ---

      # REQUIRED CHANGE: Simplified IF condition and moved logic entirely into the run block.
      - name: üîë Configure NPM Auth (For Private Packages)
        # Check if either token secret is provided OR if the default GITHUB_TOKEN is available
        if: ${{ secrets.npm-auth-token || secrets.github-token || secrets.GITHUB_TOKEN }}
        run: |
          # Use the provided npm-auth-token, fallback to the explicitly passed github-token, 
          # and finally fallback to the built-in GITHUB_TOKEN
          TOKEN=${{ secrets.npm-auth-token || secrets.github-token || secrets.GITHUB_TOKEN }}

          # Only proceed if a token is actually available (prevents empty string auth)
          if [[ -n "$TOKEN" ]]; then
            echo "//npm.pkg.github.com/:_authToken=${TOKEN}" > .npmrc
            echo "NPM authentication configured using a provided token or GITHUB_TOKEN fallback."
          fi
        shell: bash
        # Pass the tokens as environment variables to the step, which is safer than direct bash interpolation
        env:
          npm_auth_token: ${{ secrets.npm-auth-token }}
          github_token_secret: ${{ secrets.github-token }}
          github_token_default: ${{ secrets.GITHUB_TOKEN }} # Use built-in token

      # ... (Rest of the steps are fine, token usage is handled below) ...

      - name: ‚¨áÔ∏è Install Dependencies (npm ci --ignore-scripts)
        run: npm ci --ignore-scripts
        env:
          # Use the same token fallback logic safely within the environment context
          NODE_AUTH_TOKEN: ${{ secrets.npm-auth-token || secrets.github-token || secrets.GITHUB_TOKEN }}

      - name: üõ†Ô∏è Run Post-Install Scripts (npm rebuild & prepare)
        run: npm rebuild && npm run prepare --if-present

      - name: Prepare
        run: npm run prepare --if-present

      - name: üèóÔ∏è Build Project
        run: npm run build
        env:
          # Use the same token fallback logic safely within the environment context
          NODE_AUTH_TOKEN: ${{ secrets.npm-auth-token || secrets.github-token || secrets.GITHUB_TOKEN }}

      # ... (Artifact creation and upload remains the same) ...
